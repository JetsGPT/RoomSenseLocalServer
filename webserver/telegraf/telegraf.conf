# Telegraf Configuration for MQTT to InfluxDB

# Global Agent Configuration
[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = "0s"
  hostname = ""
  omit_hostname = false

# Output Plugin - InfluxDB v2
[[outputs.influxdb_v2]]
  ## The URLs of the InfluxDB cluster nodes.
  urls = ["https://influxdb:8086"]
  
  ## Token for authentication.
  token = "${INFLUX_TOKEN}"
  
  ## Organization is the name of the organization you want to write to.
  organization = "${INFLUX_ORG}"
  
  ## Destination bucket to write into.
  bucket = "${INFLUX_BUCKET}"
  
  ## Timeout for HTTP messages.
  timeout = "5s"
  
  ## Skip TLS certificate verification (required for self-signed certificates)
  insecure_skip_verify = false
  
  ## Path to CA file
  tls_ca = "/run/secrets/ssl_root_ca"

# Input Plugin - MQTT Consumer
[[inputs.mqtt_consumer]]
  ## MQTT broker URLs
  servers = ["ssl://mosquitto:8883"]
  
  ## Topics to subscribe to
  topics = [
    "ble/devices/#"
  ]
  
  ## QoS policy for messages
  qos = 0
  
  ## Connection timeout
  connection_timeout = "30s"
  
  ## Persistent session
  persistent_session = false
  
  ## Client ID
  client_id = "telegraf"

  ## Username and Password
  username = "${MQTT_USERNAME}"
  password = "${MQTT_PASSWORD}"

  ## TLS/SSL Configuration
  tls_ca = "/run/secrets/ssl_root_ca"
  
  ## Data format to consume
  data_format = "json"
  
  ## JSON configuration
  json_time_key = "ts"
  json_time_format = "unix_ms"
  
  ## Tag keys - fields from JSON to use as tags
  tag_keys = [
    "sensor_box",
    "sensor_type"
  ]
  
  ## JSON field keys - fields from JSON to use as field values
  json_string_fields = []
  
  ## Name override
  name_override = "sensor_data"
