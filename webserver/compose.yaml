services:
  webserver:
    build: .
    # Note: env_file removed for security - only explicit variables are passed
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "host.docker.internal:172.17.0.1"
    restart: unless-stopped
    environment:
      PGHOST: ${PGHOST:-postgres}
      PGUSER: ${PGUSER:-postgres}
      PGPASSWORD: ${PGPASSWORD:-password}
      PGPORT: ${PGPORT:-5432}
      PGDATABASE: ${PGDATABASE:-user}
      INFLUX_URL: ${INFLUX_URL}
      INFLUX_TOKEN: ${INFLUX_TOKEN}
      INFLUX_ORG: ${INFLUX_ORG}
      INFLUX_BUCKET: ${INFLUX_BUCKET}
      SESSION_SECRET: ${SESSION_SECRET}
      DEV_BYPASS_AUTH: ${DEV_BYPASS_AUTH:-0}
      TRUST_PROXY: ${TRUST_PROXY:-0}
      RATE_LIMIT_TRUST_PROXY: ${RATE_LIMIT_TRUST_PROXY:-0}
      PERM_CACHE_MS: ${PERM_CACHE_MS:-30000}
      BLE_GATEWAY_URL: ${BLE_GATEWAY_URL:-http://blegateway:8080}
    links:
      - "postgres:postgres"
      - "influxdb:sensors"
    ports:
      - "8081:8081"  # HTTPS port for local network access
    depends_on:
      - postgres
      - influxdb
      - blegateway
  postgres:
    image: postgres:17.4
    restart: unless-stopped
    # Note: Only PostgreSQL-specific variables - no access to other secrets
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${PGUSER:-postgres}
      POSTGRES_PASSWORD: ${PGPASSWORD:-password}
      POSTGRES_DB: ${PGDATABASE:-user}
  influxdb:
    image: influxdb:2.7.11
    # Note: Only InfluxDB-specific variables - no access to other secrets
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - ./certs:/certs:ro
    restart: unless-stopped
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USERNAME}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN}
      INFLUXD_TLS_CERT: /certs/influxdb-selfsigned.crt
      INFLUXD_TLS_KEY: /certs/influxdb-selfsigned.key
  blegateway:
    build: ./bletomqtt
    container_name: blegateway
    privileged: true
    # Note: Only MQTT variables - no access to database or other secrets
    volumes:
      - ./bletomqtt:/bletomqtt
      # D-Bus volumes (Linux only - will fail on Windows but container will still start)
      - /run/dbus:/run/dbus:ro
      - /var/run/dbus:/var/run/dbus:ro
    environment:
      - MQTT_BROKER=${MQTT_BROKER:-mosquitto}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/dbus/system_bus_socket
    # Port mapping for Windows/PC testing (use network_mode: host on Raspberry Pi)
    ports:
      - "8080:8080"
    depends_on:
      - mosquitto
    restart: unless-stopped
    devices:
      - /dev:/dev
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
      - NET_RAW
    # Uncomment below and comment out ports: for Raspberry Pi
    # network_mode: host

  mosquitto:
    image: eclipse-mosquitto:latest
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    command: mosquitto -c /mosquitto/config/mosquitto.conf

  telegraf:
    image: telegraf:1.32
    restart: unless-stopped
    # Note: Only InfluxDB variables needed for writing data
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    environment:
      INFLUX_TOKEN: ${INFLUX_TOKEN}
      INFLUX_ORG: ${INFLUX_ORG}
      INFLUX_BUCKET: ${INFLUX_BUCKET}
    depends_on:
      - mosquitto
      - influxdb

  nginx-proxy-manager:
    image: 'jc21/nginx-proxy-manager:latest'
    restart: unless-stopped
    ports:
      - '80:80'      # HTTP
      - '81:81'      # Admin UI
      - '443:443'    # HTTPS
    volumes:
      - npm_data:/data
      - npm_letsencrypt:/etc/letsencrypt
    environment:
      DB_SQLITE_FILE: "/data/database.sqlite"
    depends_on:
      - webserver
  # blegateway:
  #   build: ./bletomqtt
  #   container_name: blegateway
  #   privileged: true
  #   volumes:
  #     - ./bletomqtt:/bletomqtt
  #     - /run/dbus:/run/dbus:ro
  #   environment:
  #     - MQTT_BROKER=mosquitto
  #   depends_on:
  #     - mosquitto
  #   restart: unless-stopped
  #   devices:
  #     - /dev:/dev
  #   cap_add:
  #     - NET_ADMIN
  #     - SYS_ADMIN

volumes:
  pgdata:
  influxdb_data:
  npm_data:
  npm_letsencrypt: