# Docker Compose file with Docker Swarm secrets
# Security: Secrets are managed by Docker Swarm and only accessible to services that need them
# Note: This file is used with 'docker stack deploy' for Swarm mode

# Define secrets (will be created by init service)
secrets:
  session_secret:
    external: true  # Created by init service
  pgpassword:
    external: true  # Created by init service
  influx_password:
    external: true  # Created by init service
  influx_token:
    external: true  # Created by init service

services:
  # Note: Docker Swarm and secrets are initialized by scripts/init/start.sh script
  # before containers are started. The init service is no longer needed
  # as secrets must exist before services can reference them.

  # Main webserver application
  webserver:
    image: roomsense-webserver:latest
    # Note: container_name and extra_hosts not supported in stack deploy
    # Images must be built first using: docker compose build
    deploy:
      restart_policy:
        condition: any
      replicas: 1
    # Mount .env file for non-sensitive configuration and certs
    volumes:
      - ./.env:/webserver/.env:ro
      - ./certs:/webserver/certs:ro
    # Only grant access to secrets this service needs
    secrets:
      - session_secret
      - pgpassword
      - influx_password
      - influx_token
    environment:
      # Non-sensitive defaults (can be overridden by .env file)
      PGHOST: ${PGHOST:-postgres}
      PGUSER: ${PGUSER:-postgres}
      PGPORT: ${PGPORT:-5432}
      PGDATABASE: ${PGDATABASE:-user}
      INFLUX_URL: ${INFLUX_URL:-https://influxdb:8086}
      INFLUX_ORG: ${INFLUX_ORG:-RoomSense}
      INFLUX_BUCKET: ${INFLUX_BUCKET:-sensors_data}
      INFLUX_USERNAME: ${INFLUX_USERNAME:-admin}
      MQTT_BROKER: ${MQTT_BROKER:-localhost}
      MQTT_PORT: ${MQTT_PORT:-1883}
      BLE_GATEWAY_URL: ${BLE_GATEWAY_URL:-http://host.docker.internal:8080}
      DEV_BYPASS_AUTH: ${DEV_BYPASS_AUTH:-0}
      TRUST_PROXY: ${TRUST_PROXY:-0}
      RATE_LIMIT_TRUST_PROXY: ${RATE_LIMIT_TRUST_PROXY:-0}
      PERM_CACHE_MS: ${PERM_CACHE_MS:-30000}
      VIRTUAL_HOST: ${VIRTUAL_HOST:-RoomSense.local}
      VIRTUAL_PORT: ${VIRTUAL_PORT:-8081}
      VIRTUAL_PROTO: https
    # Note: links and depends_on not needed in Swarm mode, services are discoverable by name
    ports:
      - "8081:8081"  # HTTPS port for local network access
    networks:
      - roomsense-network

  # PostgreSQL database
  postgres:
    image: postgres:17.4
    deploy:
      restart_policy:
        condition: any
      replicas: 1
    # Only grant access to PostgreSQL password secret
    secrets:
      - pgpassword
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d
      - ./scripts/entrypoints/postgres-entrypoint-wrapper.sh:/postgres-entrypoint-wrapper.sh:ro
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${PGUSER:-postgres}
      # Password will be loaded from Docker secret by entrypoint wrapper
      POSTGRES_DB: ${PGDATABASE:-user}
    entrypoint: ["/bin/bash", "/postgres-entrypoint-wrapper.sh", "postgres"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - roomsense-network

  # InfluxDB time-series database
  influxdb:
    image: influxdb:2.7.11
    # Only grant access to InfluxDB secrets
    secrets:
      - influx_password
      - influx_token
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - ./certs:/certs:ro
      - ./scripts/entrypoints/influxdb-entrypoint-wrapper.sh:/influxdb-entrypoint-wrapper.sh:ro
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USERNAME:-admin}
      # Password and token will be loaded from Docker secrets by entrypoint wrapper
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG:-RoomSense}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET:-sensors_data}
      INFLUXD_TLS_CERT: /certs/influxdb-selfsigned.crt
      INFLUXD_TLS_KEY: /certs/influxdb-selfsigned.key
    entrypoint: ["/bin/bash", "/influxdb-entrypoint-wrapper.sh", "influxd"]
    deploy:
      restart_policy:
        condition: any
      replicas: 1
    networks:
      - roomsense-network

  # BLE Gateway service
  blegateway:
    image: roomsense-blegateway:latest
    # Note: privileged mode and network_mode: host have limitations in Swarm
    # For full host networking, consider deploying blegateway separately
    volumes:
      - ./bletomqtt:/bletomqtt
      # D-Bus volumes (Linux only - will fail on Windows but container will still start)
      - /run/dbus:/run/dbus:ro
      - /var/run/dbus:/var/run/dbus:ro
    environment:
      # In Swarm mode, use service name for MQTT broker
      # For Raspberry Pi with host networking, override with localhost in .env
      - MQTT_BROKER=${MQTT_BROKER:-mosquitto}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/dbus/system_bus_socket
    # Port mapping for Windows/PC testing (use network_mode: host on Raspberry Pi)
    # For Raspberry Pi: uncomment network_mode below and comment out ports
    # ports:
    #   - "8080:8080"
    # Note: depends_on, devices, and cap_add have limitations in Swarm mode
    deploy:
      restart_policy:
        condition: any
      replicas: 1
      placement:
        constraints:
          - node.role == manager  # Run on manager node for better device access
    networks:
      - roomsense-network

  # MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:latest
    deploy:
      restart_policy:
        condition: any
      replicas: 1
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    command: mosquitto -c /mosquitto/config/mosquitto.conf
    networks:
      - roomsense-network

  # Telegraf - metrics collection
  telegraf:
    image: telegraf:1.32
    deploy:
      restart_policy:
        condition: any
      replicas: 1
    # Only grant access to InfluxDB token (for writing metrics)
    secrets:
      - influx_token
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - ./scripts/entrypoints/telegraf-entrypoint.sh:/telegraf-entrypoint.sh:ro
    environment:
      INFLUX_ORG: ${INFLUX_ORG:-RoomSense}
      INFLUX_BUCKET: ${INFLUX_BUCKET:-sensors_data}
      # Token will be loaded from /run/secrets/influx_token by entrypoint
    entrypoint: ["/bin/sh", "/telegraf-entrypoint.sh"]
    # Note: depends_on not supported in stack deploy, services are discoverable by name
    networks:
      - roomsense-network

  # Nginx Proxy
  nginx-proxy:
    image: nginxproxy/nginx-proxy
    container_name: nginx-proxy
    restart: always
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro # Vital: Lets it "see" other containers
    networks:
      - roomsense-network

networks:
  roomsense-network:
    # Overlay network for Docker Swarm
    driver: overlay
    attachable: true

volumes:
  pgdata:
  influxdb_data:
  npm_data:
  npm_letsencrypt:
