# 1. Initialize the variable (Default = Blocked)
set $cors_origin "";

# 2. Check the incoming Origin against your ALLOWED LIST
#    Matches: http(s)://localhost:5173 OR http(s)://roomsense.local
if ($http_origin ~* "^https?://(localhost:5173|roomsense\.local)$") {
    set $cors_origin $http_origin;
}

# 3. Inject the headers for Standard Requests (GET, POST, etc.)
#    If $cors_origin is empty, the browser will block the request.
add_header Access-Control-Allow-Origin "$cors_origin" always;
add_header Access-Control-Allow-Credentials 'true' always;
add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS' always;
add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
add_header Access-Control-Expose-Headers 'Content-Length,Content-Range' always;

# 4. Handle "Preflight" OPTIONS requests
#    Browsers send this first to check permissions. It needs its own block.
if ($request_method = 'OPTIONS') {
    add_header Access-Control-Allow-Origin "$cors_origin" always;
    add_header Access-Control-Allow-Credentials 'true' always;
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;

    add_header Access-Control-Max-Age 1728000;
    add_header Content-Type 'text/plain; charset=utf-8';
    add_header Content-Length 0;
    return 204;
}